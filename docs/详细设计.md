## 多人在线协作编辑系统 - 详细设计（WSL2 Ubuntu 20.04 + libpqxx）

### 1. 构建与运行

- 依赖：`build-essential cmake libpq-dev libpqxx-dev libssl-dev spdlog nlohmann-json`
- 构建：

```
mkdir -p cpp-service/build && cd cpp-service/build
cmake .. -DCMAKE_BUILD_TYPE=Release
cmake --build . -j
```

- 配置：`config.json` 指定 PostgreSQL 连接；`.env` 仅用于本地开发。

### 2. 目录结构建议

```
cpp-service/
  src/
    controllers/
    middleware/
    services/
    repositories/
    models/
    utils/
  CMakeLists.txt
  config.json
```

### 3. 配置样例（Drogon）

```json
{
  "listeners": [{"address": "0.0.0.0", "port": 8080}],
  "app": {"threads_num": 4},
  "log": {"log_path": "./logs", "log_level": "INFO"},
  "rdbms": [
    {
      "name": "default",
      "rdbms": "postgresql",
      "host": "127.0.0.1",
      "port": 5432,
      "dbname": "collab",
      "user": "collab",
      "passwd": "collab_pass",
      "is_fast": true,
      "characterSet": "utf8"
    }
  ]
}
```

### 4. 公共组件

- 日志：spdlog 单例封装
- 数据库：libpqxx 连接管理与事务封装（仓储层使用）
- JWT：jwt-cpp（HS256），刷新令牌存 Redis 黑名单（可选）
- 校验：统一错误码与参数校验器

### 5. API 规格（部分关键）

- 认证
  - POST `/api/auth/register`
    - 请求：`{ email?, phone?, password }`
    - 响应：`{ id }`
  - POST `/api/auth/login`
    - 请求：`{ account, password }`
    - 响应：`{ access_token, refresh_token, user: { id, role, nickname, avatar_url } }`
  - POST `/api/auth/refresh` → `{ access_token }`
  - GET `/api/users/me` → 当前用户信息
  - PATCH `/api/users/me` → `{ nickname?, avatar_url?, bio? }`

- 文档
  - POST `/api/docs` → `{ id }`
  - GET `/api/docs/:id` → `{ id, title, owner_id, tags, last_published_version_id, updated_at }`
  - PATCH `/api/docs/:id` → 更新标题/锁定
  - DELETE `/api/docs/:id`
  - GET `/api/docs` → 分页/筛选
  - POST `/api/docs/:id/publish` → 创建版本并更新索引
  - GET `/api/docs/:id/versions` → 版本列表
  - POST `/api/docs/:id/rollback/:versionId` → 回滚

- 协作对接
  - POST `/api/collab/token` → `{ token, expiresIn }`（校验 ACL）
  - GET `/api/collab/bootstrap/:docId` → `{ snapshot_url, sha256 }`
  - POST `/api/collab/snapshot/:docId` → `{ version_id }`

- 评论/任务/通知/搜索：与《设计文档》一致，详见 API 列表。

### 6. 时序与流程

1) 协作快照回调

```
Client -> y-websocket -> Cpp API (snapshot webhook) -> DB(document_version)
                                       \-> Async indexer(Meilisearch)
                                       \-> Notify collaborators
```

2) 加入房间鉴权

```
Client -> Cpp API (/collab/token) -> JWT(一次性) -> y-websocket 验证 -> Join room
```

3) 版本发布/回滚：更新 `document.last_published_version_id`，刷新索引。

### 7. 错误码规范（示例）

```
0  OK
1001 INVALID_PARAM
1002 UNAUTHORIZED
1003 FORBIDDEN
1004 NOT_FOUND
2001 DB_ERROR
2002 STORAGE_ERROR
2003 SEARCH_ERROR
```

### 8. 代码骨架建议

- 控制器：使用 Drogon HttpController；按资源分文件，如 `AuthController`, `DocumentController`。
- 中间件：`AuthFilter`（解析 JWT）、`AclFilter`（文档权限检查）。
- 仓储：`UserRepository`, `DocumentRepository`, `VersionRepository`（基于 libpqxx）。
- 服务：`AuthService`, `DocService`, `SearchService`, `StorageService`。

### 9. 安全要点

- JWT 短期 + 刷新；密码使用 BCrypt；输入校验；速率限制；审计日志。
- 文件上传：扩展名/MIME/大小限制，生成预签名 URL 访问对象存储。

### 10. 运维与发布

- Docker Compose 启动全部依赖；C++ 服务以镜像运行。
- 健康检查：`/health` 返回 200；数据库/对象存储/检索服务开机自检。
