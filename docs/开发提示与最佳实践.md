# å¼€å‘æç¤ºä¸æœ€ä½³å®è·µ

## ğŸ¯ è‡ªä¸»å¼€å‘è·¯å¾„

### ç¬¬ä¸€æ­¥ï¼šå·¥å…·ç±»å¼€å‘æç¤º

#### JWT å·¥å…·ç±»æç¤º

**å…³é”®ç‚¹ï¼š**

- Drogon æ²¡æœ‰å†…ç½® JWTï¼Œä½ éœ€è¦å¼•å…¥ `jwt-cpp` åº“æˆ–æ‰‹åŠ¨å®ç° JWT ç¼–ç /è§£ç 
- JWT ç»“æ„ï¼š`Header.Payload.Signature`ï¼ˆbase64url ç¼–ç ï¼‰
- æ¨èä½¿ç”¨ HMAC-SHA256ï¼ˆHS256ï¼‰ç®—æ³•ï¼Œå¯†é’¥ä»é…ç½®è¯»å–
- Payload é€šå¸¸åŒ…å«ï¼š`{"user_id": 123, "exp": <timestamp>}`

**å®ç°æ€è·¯ï¼š**

```cpp
class JwtUtils {
public:
    static std::string generateToken(int userId, const std::string& secret, int expiresIn);
    static bool verifyToken(const std::string& token, const std::string& secret);
    static int getUserIdFromToken(const std::string& token); // è§£æ payload
};
```

**å­¦ä¹ èµ„æºï¼š**

- JWT å®˜æ–¹æ–‡æ¡£ï¼š<https://jwt.io/introduction>
- jwt-cpp GitHubï¼š<https://github.com/Thalhammer/jwt-cpp>
- å¦‚æœä¸ç”¨åº“ï¼Œå¯ä»¥ç”¨ OpenSSL çš„ HMAC å‡½æ•°æ‰‹åŠ¨å®ç°

**å¸¸è§é™·é˜±ï¼š**

- å¯†é’¥ä¸è¦ç¡¬ç¼–ç ï¼Œä»ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶è¯»å–
- refresh_token çš„è¿‡æœŸæ—¶é—´åº”è¯¥æ¯” access_token é•¿å¾ˆå¤šï¼ˆå¦‚ 30 å¤© vs 15 åˆ†é’Ÿï¼‰
- token è¿‡æœŸæ—¶é—´ç”¨æ—¶é—´æˆ³ï¼ˆUnix timestampï¼‰ï¼Œä¸æ˜¯ç§’æ•°

---

#### å¯†ç å·¥å…·ç±»æç¤º

**å…³é”®ç‚¹ï¼š**

- å¯†ç **ç»å¯¹ä¸èƒ½**æ˜æ–‡å­˜å‚¨ï¼Œå¿…é¡»å“ˆå¸Œ
- æ¨èä½¿ç”¨ **BCrypt**ï¼ˆæ…¢å“ˆå¸Œï¼ŒæŠ—æš´åŠ›ç ´è§£ï¼‰æˆ– **Argon2**ï¼ˆç°ä»£æ¨èï¼‰
- å¦‚æœç³»ç»Ÿæ²¡æœ‰ bcrypt åº“ï¼Œå¯ä»¥ç”¨ OpenSSL çš„ `EVP_BytesToKey` æˆ– SHA-256 + éšæœºç›

**å®ç°æ€è·¯ï¼š**

```cpp
class PasswordUtils {
public:
    static std::string hashPassword(const std::string& plainPassword);
    static bool verifyPassword(const std::string& plainPassword, const std::string& hash);
};
```

**BCrypt è¦ç‚¹ï¼š**

- BCrypt ä¼šåœ¨å“ˆå¸Œä¸­è‡ªåŠ¨åŒ…å«ç›ï¼ˆsaltï¼‰ï¼Œæ‰€ä»¥ç›¸åŒå¯†ç æ¯æ¬¡å“ˆå¸Œç»“æœä¸åŒ
- éªŒè¯æ—¶åªéœ€è¦ä¼ å…¥æ˜æ–‡å¯†ç å’Œå­˜å‚¨çš„å“ˆå¸Œå€¼å³å¯

**å¦‚æœä¸ç”¨ BCryptï¼ˆæ›¿ä»£æ–¹æ¡ˆï¼‰ï¼š**

```cpp
// ä½¿ç”¨ SHA-256 + éšæœºç›
std::string salt = generateRandomSalt(16);
std::string hash = sha256(password + salt);
// å­˜å‚¨æ ¼å¼ï¼š$sha256$salt$hash
```

**å­¦ä¹ èµ„æºï¼š**

- OpenSSL æ–‡æ¡£ï¼š<https://www.openssl.org/docs/>
- BCrypt ç®—æ³•åŸç†ï¼šäº†è§£ cost factorï¼ˆè½®æ•°ï¼‰

---

#### æ•°æ®åº“å·¥å…·ç±»æç¤º

**å…³é”®ç‚¹ï¼š**

- Drogon å·²ç»æœ‰å†…ç½®çš„æ•°æ®åº“è¿æ¥æ± ï¼Œç›´æ¥ä½¿ç”¨å³å¯
- åœ¨ `config.json` ä¸­é…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯
- ä½¿ç”¨ libpqxx æ‰§è¡Œ SQLï¼ˆDrogon æ”¯æŒï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨ ORMï¼‰

**Drogon æ•°æ®åº“ä½¿ç”¨æ–¹å¼ï¼š**

```cpp
// è·å–æ•°æ®åº“å®¢æˆ·ç«¯ï¼ˆè¿æ¥æ± ï¼‰
auto db = drogon::app().getDbClient();

// æ‰§è¡ŒæŸ¥è¯¢ï¼ˆå¼‚æ­¥ï¼‰
db->execSqlAsync(
    "SELECT * FROM \"user\" WHERE email = $1",
    [callback](const drogon::orm::Result& r) {
        // å¤„ç†ç»“æœ
    },
    [callback](const drogon::Exception& e) {
        // å¤„ç†é”™è¯¯
    },
    email
);
```

**å¸¸è§é™·é˜±ï¼š**

- SQL æ³¨å…¥ï¼š**æ°¸è¿œä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢**ï¼ˆ`$1, $2`ï¼‰ï¼Œä¸è¦æ‹¼æ¥å­—ç¬¦ä¸²
- äº‹åŠ¡ï¼šéœ€è¦äº‹åŠ¡æ—¶ç”¨ `execTransactionAsync`
- å¼‚æ­¥å›è°ƒï¼šDrogon çš„æ•°æ®åº“æ“ä½œæ˜¯å¼‚æ­¥çš„ï¼Œæ³¨æ„å›è°ƒå¤„ç†

**å­¦ä¹ èµ„æºï¼š**

- Drogon æ•°æ®åº“æ–‡æ¡£ï¼š<https://drogon.docsforge.com/>
- libpqxx æ–‡æ¡£ï¼š<https://libpqxx.readthedocs.io/>

---

### ç¬¬äºŒæ­¥ï¼šè®¤è¯æ§åˆ¶å™¨å¼€å‘æç¤º

#### æ³¨å†Œæ¥å£ `POST /api/auth/register`

**éœ€è¦åšçš„äº‹æƒ…ï¼š**

1. è§£æè¯·æ±‚ä½“ JSONï¼ˆ`email`, `password`ï¼‰
2. **éªŒè¯è¾“å…¥**ï¼š
   - é‚®ç®±æ ¼å¼ï¼ˆæ­£åˆ™æˆ–ç®€å•æ£€æŸ¥ `@` å’Œ `.`ï¼‰
   - å¯†ç é•¿åº¦ï¼ˆå»ºè®®è‡³å°‘ 8 ä½ï¼‰
3. æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨ï¼ˆæŸ¥è¯¢æ•°æ®åº“ï¼‰
4. å“ˆå¸Œå¯†ç 
5. æ’å…¥æ•°æ®åº“ï¼ˆ`INSERT INTO "user" ...`ï¼‰
6. è¿”å›ç”¨æˆ· ID æˆ–æˆåŠŸæ¶ˆæ¯

**Drogon æ§åˆ¶å™¨ç¤ºä¾‹ç»“æ„ï¼š**

```cpp
class AuthController : public drogon::HttpController<AuthController> {
public:
    METHOD_LIST_BEGIN
        ADD_METHOD_TO(AuthController::register, "/api/auth/register", Post);
        ADD_METHOD_TO(AuthController::login, "/api/auth/login", Post);
    METHOD_LIST_END

    void register(const HttpRequestPtr& req, 
                  std::function<void(const HttpResponsePtr&)>&& callback);
    void login(const HttpRequestPtr& req, 
               std::function<void(const HttpResponsePtr&)>&& callback);
};
```

**è¯·æ±‚è§£æï¼š**

```cpp
Json::Value json;
if (!req->jsonObject() || !req->jsonObject()->get("email", json["email"])) {
    // è¿”å› 400 Bad Request
}
std::string email = json["email"].asString();
```

**é”™è¯¯å¤„ç†ï¼š**

- é‚®ç®±å·²å­˜åœ¨ â†’ è¿”å› 409 Conflict
- å¯†ç å¤ªçŸ­ â†’ è¿”å› 400 Bad Request
- æ•°æ®åº“é”™è¯¯ â†’ è¿”å› 500 Internal Server Error

---

#### ç™»å½•æ¥å£ `POST /api/auth/login`

**æµç¨‹ï¼š**

1. è§£æ `email` å’Œ `password`
2. æŸ¥è¯¢æ•°æ®åº“ï¼š`SELECT id, password_hash, role FROM "user" WHERE email = $1`
3. å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ â†’ è¿”å› 401 Unauthorized
4. éªŒè¯å¯†ç ï¼ˆç”¨ `PasswordUtils::verifyPassword`ï¼‰
5. å¦‚æœå¯†ç é”™è¯¯ â†’ è¿”å› 401 Unauthorized
6. ç”Ÿæˆ JWT tokenï¼ˆaccess_token + refresh_tokenï¼‰
7. è¿”å› token å’Œç”¨æˆ·ä¿¡æ¯

**å“åº”æ ¼å¼ï¼š**

```json
{
  "access_token": "eyJ...",
  "refresh_token": "eyJ...",
  "user": {
    "id": 123,
    "email": "user@example.com",
    "role": "editor"
  }
}
```

---

#### åˆ·æ–° Token `POST /api/auth/refresh`

**æµç¨‹ï¼š**

1. è§£æ `refresh_token`
2. éªŒè¯ refresh_token æ˜¯å¦æœ‰æ•ˆä¸”æœªè¿‡æœŸ
3. ä» token ä¸­æå– user_id
4. ç”Ÿæˆæ–°çš„ access_tokenï¼ˆä¸éœ€è¦æ–°çš„ refresh_tokenï¼‰
5. è¿”å›æ–°çš„ access_token

---

### ç¬¬ä¸‰æ­¥ï¼šJWT è®¤è¯ä¸­é—´ä»¶æç¤º

**ä¸­é—´ä»¶/è¿‡æ»¤å™¨çš„ä½œç”¨ï¼š**

- åœ¨æ§åˆ¶å™¨æ‰§è¡Œ**ä¹‹å‰**è¿è¡Œ
- æ£€æŸ¥è¯·æ±‚æ˜¯å¦æœ‰æœ‰æ•ˆçš„ JWT token
- å¦‚æœæ— æ•ˆ â†’ è¿”å› 401ï¼Œä¸è°ƒç”¨æ§åˆ¶å™¨
- å¦‚æœæœ‰æ•ˆ â†’ è§£æ tokenï¼Œå°† user_id å­˜å…¥è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œç»§ç»­æ‰§è¡Œæ§åˆ¶å™¨

**Drogon è¿‡æ»¤å™¨å®ç°ï¼š**

```cpp
class JwtAuthFilter : public drogon::HttpFilter<JwtAuthFilter> {
public:
    virtual void doFilter(const HttpRequestPtr& req,
                         drogon::FilterCallback&& fcb,
                         drogon::FilterChainCallback&& fccb) override;
};
```

**å…³é”®æ­¥éª¤ï¼š**

1. ä» Header æå–ï¼š`Authorization: Bearer <token>`
2. å¦‚æœæ²¡æœ‰ â†’ è¿”å› 401
3. éªŒè¯ tokenï¼ˆ`JwtUtils::verifyToken`ï¼‰
4. è§£æ user_idï¼ˆ`JwtUtils::getUserIdFromToken`ï¼‰
5. å°† user_id å­˜å…¥ `req->attributes()` æˆ–è‡ªå®šä¹‰ä¸Šä¸‹æ–‡
6. è°ƒç”¨ `fccb()` ç»§ç»­ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨/æ§åˆ¶å™¨

**åœ¨æ§åˆ¶å™¨ä¸­è·å–ç”¨æˆ·IDï¼š**

```cpp
auto userId = req->getAttributes()->get<int>("user_id");
```

---

### ç¬¬å››æ­¥ï¼šæ–‡æ¡£ CRUD å¼€å‘æç¤º

#### åˆ›å»ºæ–‡æ¡£ `POST /api/docs`

**æµç¨‹ï¼š**

1. éªŒè¯ JWTï¼ˆä¸­é—´ä»¶å·²åšï¼Œç›´æ¥è·å– user_idï¼‰
2. è§£æè¯·æ±‚ä½“ï¼š`{"title": "..."}`
3. æ’å…¥æ•°æ®åº“ï¼š

   ```sql
   INSERT INTO document (owner_id, title) VALUES ($1, $2) RETURNING id;
   ```

4. åŒæ—¶æ’å…¥ ACLï¼ˆowner æƒé™ï¼‰ï¼š

   ```sql
   INSERT INTO doc_acl (doc_id, user_id, permission) VALUES ($1, $2, 'owner');
   ```

5. è¿”å›æ–‡æ¡£ä¿¡æ¯

---

#### æƒé™æ£€æŸ¥æ€è·¯

**æ–‡æ¡£æƒé™è§„åˆ™ï¼š**

- `owner`ï¼šæ‹¥æœ‰è€…ï¼Œå¯ä»¥åˆ é™¤ã€ç¼–è¾‘ã€æŸ¥çœ‹
- `editor`ï¼šç¼–è¾‘è€…ï¼Œå¯ä»¥ç¼–è¾‘ã€æŸ¥çœ‹
- `viewer`ï¼šæŸ¥çœ‹è€…ï¼Œåªèƒ½æŸ¥çœ‹

**å®ç°æƒé™æ£€æŸ¥å‡½æ•°ï¼š**

```cpp
bool checkDocumentPermission(int docId, int userId, const std::string& requiredPermission) {
    // æŸ¥è¯¢ doc_acl è¡¨
    // å¦‚æœç”¨æˆ·æ˜¯ ownerï¼Œå…è®¸æ‰€æœ‰æ“ä½œ
    // å¦‚æœ requiredPermission æ˜¯ "view"ï¼Œeditor å’Œ viewer éƒ½å¯ä»¥
    // å¦‚æœ requiredPermission æ˜¯ "edit"ï¼Œåªæœ‰ owner å’Œ editor å¯ä»¥
}
```

---

## ğŸ› å¸¸è§é—®é¢˜ä¸è°ƒè¯•æŠ€å·§

### 1. ç¼–è¯‘é”™è¯¯

- **æ‰¾ä¸åˆ°å¤´æ–‡ä»¶**ï¼šæ£€æŸ¥ CMakeLists.txt çš„ `target_include_directories`
- **é“¾æ¥é”™è¯¯**ï¼šæ£€æŸ¥ `target_link_libraries` æ˜¯å¦åŒ…å«æ‰€æœ‰ä¾èµ–

### 2. è¿è¡Œæ—¶é”™è¯¯

- **æ•°æ®åº“è¿æ¥å¤±è´¥**ï¼šæ£€æŸ¥ `config.json` çš„æ•°æ®åº“é…ç½®ï¼Œç¡®è®¤ PostgreSQL æ­£åœ¨è¿è¡Œ
- **401 æœªæˆæƒ**ï¼šæ£€æŸ¥ token æ˜¯å¦æ­£ç¡®ä¼ é€’ï¼Œæ ¼å¼æ˜¯å¦ä¸º `Bearer <token>`
- **500 æœåŠ¡å™¨é”™è¯¯**ï¼šæŸ¥çœ‹æœåŠ¡æ—¥å¿—ï¼Œé€šå¸¸æ˜¯ SQL è¯­æ³•é”™è¯¯æˆ–ç©ºæŒ‡é’ˆ

### 3. è°ƒè¯•æŠ€å·§

- **æ‰“å°æ—¥å¿—**ï¼šä½¿ç”¨ `LOG_INFO`, `LOG_ERROR` è¾“å‡ºå…³é”®ä¿¡æ¯
- **æµ‹è¯•æ¥å£**ï¼šç”¨ `curl` æˆ– Postman æµ‹è¯•æ¯ä¸ªæ¥å£
- **æ•°æ®åº“æ£€æŸ¥**ï¼šç›´æ¥ç”¨ `psql` æŸ¥è¯¢æ•°æ®åº“ï¼Œç¡®è®¤æ•°æ®æ˜¯å¦æ­£ç¡®æ’å…¥

---

## ğŸ“š å­¦ä¹ èµ„æºæ¨è

1. **Drogon å®˜æ–¹æ–‡æ¡£**ï¼š<https://drogon.docsforge.com/>
2. **libpqxx æ–‡æ¡£**ï¼š<https://libpqxx.readthedocs.io/>
3. **JWT åŸç†**ï¼š<https://jwt.io/introduction>
4. **PostgreSQL SQL æ•™ç¨‹**ï¼š<https://www.postgresql.org/docs/current/tutorial.html>

---

## âœ… æ£€æŸ¥æ¸…å•

å®Œæˆæ¯ä¸ªåŠŸèƒ½åï¼Œæ£€æŸ¥ï¼š

- [ ] è¾“å…¥éªŒè¯ï¼ˆé‚®ç®±æ ¼å¼ã€å¯†ç é•¿åº¦ç­‰ï¼‰
- [ ] é”™è¯¯å¤„ç†ï¼ˆç”¨æˆ·ä¸å­˜åœ¨ã€å¯†ç é”™è¯¯ç­‰ï¼‰
- [ ] SQL æ³¨å…¥é˜²æŠ¤ï¼ˆä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼‰
- [ ] è¿”å›æ­£ç¡®çš„ HTTP çŠ¶æ€ç 
- [ ] æ—¥å¿—è®°å½•å…³é”®æ“ä½œ
- [ ] ç”¨ curl/Postman æµ‹è¯•æ¥å£

---

## ğŸ’¡ è¿›é˜¶æç¤º

1. **å¼‚æ­¥å¤„ç†**ï¼šDrogon çš„æ•°æ®åº“æ“ä½œæ˜¯å¼‚æ­¥çš„ï¼Œæ³¨æ„å›è°ƒåµŒå¥—ï¼Œå¯ä»¥è€ƒè™‘ç”¨ `std::async` æˆ–åç¨‹ç®€åŒ–
2. **é”™è¯¯ç ç»Ÿä¸€**ï¼šå®šä¹‰ç»Ÿä¸€çš„é”™è¯¯ç è§„èŒƒï¼Œæ–¹ä¾¿å‰ç«¯å¤„ç†
3. **è¾“å…¥éªŒè¯**ï¼šå¯ä»¥åˆ›å»ºé€šç”¨çš„éªŒè¯å‡½æ•°ï¼Œé¿å…é‡å¤ä»£ç 
4. **ä»£ç å¤ç”¨**ï¼šå°†æ•°æ®åº“æŸ¥è¯¢å°è£…æˆå‡½æ•°ï¼Œé¿å…é‡å¤ SQL

---

## ğŸš€ å¼€å§‹å§

æŒ‰ç…§è¿™ä¸ªæç¤ºï¼Œä¸€æ­¥æ­¥å®ç°ã€‚é‡åˆ°å…·ä½“é—®é¢˜æ—¶ï¼š

1. å…ˆæŸ¥çœ‹é”™è¯¯ä¿¡æ¯
2. æŸ¥é˜…ç›¸å…³æ–‡æ¡£
3. æœç´¢ç±»ä¼¼é—®é¢˜ï¼ˆStack Overflowã€GitHub Issuesï¼‰
4. å¦‚æœè¿˜æ˜¯å¡ä½ï¼Œå†æ¥é—®æˆ‘å…·ä½“çš„é—®é¢˜

**è®°ä½ï¼šè‡ªå·±è§£å†³é—®é¢˜æ˜¯æœ€å¿«çš„æˆé•¿æ–¹å¼ï¼** ğŸ’ª
