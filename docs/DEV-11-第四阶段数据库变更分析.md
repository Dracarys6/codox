# ç¬¬å››é˜¶æ®µæ•°æ®åº“å˜æ›´åˆ†æ

## ğŸ“Š å½“å‰æ•°æ®åº“è¡¨ç»“æ„æ¦‚è§ˆ

### å·²æœ‰è¡¨ï¼ˆ1-3é˜¶æ®µï¼‰

| è¡¨å | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| `user` | ç”¨æˆ·è¡¨ | âœ… å·²æœ‰ |
| `user_profile` | ç”¨æˆ·èµ„æ–™è¡¨ | âœ… å·²æœ‰ |
| `document` | æ–‡æ¡£è¡¨ | âœ… å·²æœ‰ |
| `doc_acl` | æ–‡æ¡£è®¿é—®æ§åˆ¶è¡¨ | âœ… å·²æœ‰ |
| `document_version` | æ–‡æ¡£ç‰ˆæœ¬è¡¨ | âœ… å·²æœ‰ |
| `tag` | æ ‡ç­¾è¡¨ | âœ… å·²æœ‰ |
| `doc_tag` | æ–‡æ¡£æ ‡ç­¾å…³è”è¡¨ | âœ… å·²æœ‰ |
| `comment` | è¯„è®ºè¡¨ | âœ… å·²æœ‰ |
| `task` | ä»»åŠ¡è¡¨ | âœ… å·²æœ‰ |
| `notification` | é€šçŸ¥è¡¨ | âœ… å·²æœ‰ |

### å·²æœ‰ç´¢å¼•

- `idx_document_owner_updated` - æ–‡æ¡£æŒ‰æ‰€æœ‰è€…ã€æ›´æ–°æ—¶é—´ç´¢å¼•
- `idx_doc_tag_tag` - æ–‡æ¡£æ ‡ç­¾å…³è”ç´¢å¼•
- `idx_comment_doc_created` - è¯„è®ºæŒ‰æ–‡æ¡£ã€åˆ›å»ºæ—¶é—´ç´¢å¼•
- `idx_task_doc_status` - ä»»åŠ¡æŒ‰æ–‡æ¡£ã€çŠ¶æ€ç´¢å¼•

---

## ğŸ†• ç¬¬å››é˜¶æ®µéœ€è¦æ·»åŠ çš„è¡¨

### 1. å®æ—¶é€šè®¯æ¨¡å—ï¼ˆ4ä¸ªæ–°è¡¨ï¼‰

#### 1.1 `chat_room` - èŠå¤©å®¤è¡¨
**ç”¨é€”**ï¼šå­˜å‚¨èŠå¤©å®¤ä¿¡æ¯ï¼ˆç§èŠã€ç¾¤èŠã€æ–‡æ¡£å†…èŠå¤©ï¼‰

**å­—æ®µ**ï¼š
- `id` - ä¸»é”®
- `name` - èŠå¤©å®¤åç§°
- `type` - ç±»å‹ï¼ˆ'direct', 'group', 'document'ï¼‰
- `doc_id` - å…³è”æ–‡æ¡£IDï¼ˆå¯é€‰ï¼Œç”¨äºæ–‡æ¡£å†…èŠå¤©ï¼‰
- `created_by` - åˆ›å»ºè€…ID
- `created_at` - åˆ›å»ºæ—¶é—´
- `updated_at` - æ›´æ–°æ—¶é—´

#### 1.2 `chat_room_member` - èŠå¤©å®¤æˆå‘˜è¡¨
**ç”¨é€”**ï¼šå­˜å‚¨èŠå¤©å®¤æˆå‘˜å…³ç³»

**å­—æ®µ**ï¼š
- `id` - ä¸»é”®
- `room_id` - èŠå¤©å®¤ID
- `user_id` - ç”¨æˆ·ID
- `joined_at` - åŠ å…¥æ—¶é—´
- `last_read_at` - æœ€åé˜…è¯»æ—¶é—´

#### 1.3 `chat_message` - èŠå¤©æ¶ˆæ¯è¡¨
**ç”¨é€”**ï¼šå­˜å‚¨èŠå¤©æ¶ˆæ¯

**å­—æ®µ**ï¼š
- `id` - ä¸»é”®
- `room_id` - èŠå¤©å®¤ID
- `sender_id` - å‘é€è€…ID
- `content` - æ¶ˆæ¯å†…å®¹
- `message_type` - æ¶ˆæ¯ç±»å‹ï¼ˆ'text', 'file', 'image'ç­‰ï¼‰
- `file_url` - æ–‡ä»¶URLï¼ˆå¯é€‰ï¼‰
- `reply_to` - å›å¤çš„æ¶ˆæ¯IDï¼ˆå¯é€‰ï¼‰
- `created_at` - åˆ›å»ºæ—¶é—´

#### 1.4 `chat_message_read` - æ¶ˆæ¯å·²è¯»çŠ¶æ€è¡¨
**ç”¨é€”**ï¼šè®°å½•æ¶ˆæ¯çš„å·²è¯»çŠ¶æ€

**å­—æ®µ**ï¼š
- `id` - ä¸»é”®
- `message_id` - æ¶ˆæ¯ID
- `user_id` - ç”¨æˆ·ID
- `read_at` - å·²è¯»æ—¶é—´

**ç´¢å¼•éœ€æ±‚**ï¼š
- `chat_room`: `(doc_id)` - æ–‡æ¡£èŠå¤©å®¤æŸ¥è¯¢
- `chat_room_member`: `(room_id, user_id)` - æˆå‘˜æŸ¥è¯¢ï¼ˆå·²æœ‰UNIQUEçº¦æŸï¼‰
- `chat_message`: `(room_id, created_at DESC)` - æ¶ˆæ¯å†å²æŸ¥è¯¢
- `chat_message_read`: `(message_id, user_id)` - å·²è¯»çŠ¶æ€æŸ¥è¯¢ï¼ˆå·²æœ‰UNIQUEçº¦æŸï¼‰

---

### 2. é€šçŸ¥ç³»ç»Ÿå¢å¼ºï¼ˆ1ä¸ªæ–°è¡¨ + ç´¢å¼•ä¼˜åŒ–ï¼‰

#### 2.1 `notification_setting` - é€šçŸ¥è®¾ç½®è¡¨
**ç”¨é€”**ï¼šå­˜å‚¨ç”¨æˆ·çš„é€šçŸ¥åå¥½è®¾ç½®

**å­—æ®µ**ï¼š
- `id` - ä¸»é”®
- `user_id` - ç”¨æˆ·ID
- `notification_type` - é€šçŸ¥ç±»å‹ï¼ˆ'comment', 'task_assigned'ç­‰ï¼‰
- `email_enabled` - é‚®ä»¶é€šçŸ¥å¼€å…³
- `push_enabled` - æ¨é€é€šçŸ¥å¼€å…³
- `in_app_enabled` - åº”ç”¨å†…é€šçŸ¥å¼€å…³
- `created_at` - åˆ›å»ºæ—¶é—´
- `updated_at` - æ›´æ–°æ—¶é—´

**ç´¢å¼•éœ€æ±‚**ï¼š
- `(user_id, notification_type)` - ç”¨æˆ·è®¾ç½®æŸ¥è¯¢ï¼ˆå·²æœ‰UNIQUEçº¦æŸï¼‰

#### 2.2 `notification` è¡¨ç´¢å¼•ä¼˜åŒ–
**éœ€è¦æ·»åŠ çš„ç´¢å¼•**ï¼š
- `idx_notification_user_type` - `(user_id, type)` - æŒ‰ç”¨æˆ·å’Œç±»å‹è¿‡æ»¤
- `idx_notification_created_at` - `(created_at DESC)` - æŒ‰æ—¶é—´æ’åº

---

## ğŸ“‹ æ•°æ®åº“å˜æ›´æ€»ç»“

### æ–°å¢è¡¨ï¼ˆ5ä¸ªï¼‰

1. âœ… `chat_room` - èŠå¤©å®¤
2. âœ… `chat_room_member` - èŠå¤©å®¤æˆå‘˜
3. âœ… `chat_message` - èŠå¤©æ¶ˆæ¯
4. âœ… `chat_message_read` - æ¶ˆæ¯å·²è¯»çŠ¶æ€
5. âœ… `notification_setting` - é€šçŸ¥è®¾ç½®

### æ–°å¢ç´¢å¼•ï¼ˆ4ä¸ªï¼‰

1. âœ… `idx_chat_room_doc` - `chat_room(doc_id)`
2. âœ… `idx_chat_message_room_created` - `chat_message(room_id, created_at DESC)`
3. âœ… `idx_notification_user_type` - `notification(user_id, type)`
4. âœ… `idx_notification_created_at` - `notification(created_at DESC)`

### ä¸éœ€è¦æ•°æ®åº“å˜æ›´çš„åŠŸèƒ½

ä»¥ä¸‹åŠŸèƒ½ä¸éœ€è¦æ–°å¢æ•°æ®åº“è¡¨ï¼Œåªéœ€è¦åç«¯å’Œå‰ç«¯å®ç°ï¼š

- âœ… **æ–‡æ¡£å¯¼å…¥å¯¼å‡º** - ä½¿ç”¨ç°æœ‰ `document` å’Œ `document_version` è¡¨
- âœ… **ç›‘æ§ä¸å‘Šè­¦** - ä½¿ç”¨ Prometheusï¼Œæ— éœ€æ•°æ®åº“è¡¨
- âœ… **é›†ä¸­æ—¥å¿—** - ä½¿ç”¨ Loki/ELKï¼Œæ— éœ€æ•°æ®åº“è¡¨
- âœ… **PWA æ”¯æŒ** - çº¯å‰ç«¯åŠŸèƒ½ï¼Œæ— éœ€æ•°æ®åº“è¡¨
- âŒ **æ–‡æ¡£æ¨¡æ¿ç³»ç»Ÿ** - ä¸å®ç°æ­¤åŠŸèƒ½

---

## ğŸ”„ æ•°æ®ç±»å‹è¯´æ˜

### æ—¶é—´æˆ³å­—æ®µ
- ä½¿ç”¨ `TIMESTAMPTZ`ï¼ˆå¸¦æ—¶åŒºçš„æ—¶é—´æˆ³ï¼‰ï¼Œä¸ç°æœ‰è¡¨ä¿æŒä¸€è‡´
- é»˜è®¤å€¼ï¼š`DEFAULT NOW()`

### ID å­—æ®µ
- ä½¿ç”¨ `BIGSERIAL`ï¼ˆä¸ç°æœ‰è¡¨ä¿æŒä¸€è‡´ï¼‰ï¼Œå¯¹åº” `BIGINT`
- å¤–é”®å¼•ç”¨ä½¿ç”¨ `BIGINT`

### æ–‡æœ¬å­—æ®µ
- çŸ­æ–‡æœ¬ï¼š`VARCHAR(255)` æˆ– `VARCHAR(64)`
- é•¿æ–‡æœ¬ï¼š`TEXT`
- JSON æ•°æ®ï¼š`JSONB`

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å¤–é”®çº¦æŸ**ï¼šæ‰€æœ‰å¤–é”®éƒ½è®¾ç½®äº† `ON DELETE CASCADE`ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
2. **å”¯ä¸€çº¦æŸ**ï¼š`chat_room_member` å’Œ `chat_message_read` ä½¿ç”¨ `UNIQUE(room_id, user_id)` å’Œ `UNIQUE(message_id, user_id)` é˜²æ­¢é‡å¤
3. **ç´¢å¼•ä¼˜åŒ–**ï¼šæ ¹æ®æŸ¥è¯¢éœ€æ±‚æ·»åŠ ç´¢å¼•ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
4. **å‘åå…¼å®¹**ï¼šæ‰€æœ‰æ–°å¢è¡¨éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½

---

## ğŸš€ è¿ç§»æ­¥éª¤å»ºè®®

1. **å¤‡ä»½æ•°æ®åº“**ï¼šåœ¨æ‰§è¡Œè¿ç§»å‰å¤‡ä»½ç°æœ‰æ•°æ®
2. **æ‰§è¡Œè¿ç§»è„šæœ¬**ï¼šè¿è¡Œ `cpp-service/sql/migration_phase4.sql`
3. **éªŒè¯è¡¨ç»“æ„**ï¼šæ£€æŸ¥æ‰€æœ‰è¡¨æ˜¯å¦æ­£ç¡®åˆ›å»º
4. **æµ‹è¯•åŠŸèƒ½**ï¼šæµ‹è¯•ç›¸å…³åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ

---

**æœ€åæ›´æ–°**ï¼š2025-11

