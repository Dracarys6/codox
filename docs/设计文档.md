# 多人在线协作编辑系统（C++ 后端 + Yjs 实时协作）设计文档

## 1. 需求概述（来自要求文档的落地）

- **用户管理**：注册/登录（邮箱/手机）、密码重置、个人资料、头像、联系信息；RBAC 角色（admin/editor/viewer）+ 文档级 ACL；操作审计。
- **文档管理**：文档创建/编辑、模板、自动保存；标签/分类/搜索；（选做）版本历史、对比、回滚、锁定；（选做）导入导出（Word/PDF/Markdown）。
- **实时协作**：多人同时编辑、实时光标/选区；评论/批注/回复/@及通知；任务分配与状态跟踪。
- **通知与通讯**：站内实时通知（编辑、评论、任务）、历史与偏好；（选做）聊天/视频会议/屏幕共享/文件共享。
- **移动端（选做）**：响应式与 PWA，离线编辑与同步。
- **系统管理（选做）**：监控日志、报警、健康报告、配置开关。

范围建议（最小可行版本）：

1) 账号 + RBAC/ACL + 文档 CRUD + 自动保存
2) 富文本（单人）→ 引入 Yjs 实时协作（多人光标）
3) 评论/@与站内通知；文档列表/标签/条件搜索
4) 版本发布/回滚（选做）、全文检索（选做）

---

## 2. 技术选型与架构

- **前端**：React + TypeScript + Tiptap（ProseMirror）+ Yjs；WebSocket 连接 `y-websocket` 协作服务。
- **协作服务（实时）**：`y-websocket`（Node），负责 CRDT 合并、游标同步、会话管理与快照回调。
- **业务后端（C++）**：Drogon（HTTP/WebSocket、过滤器、中间件、JWT、文件上传），负责用户、权限、文档元数据、版本、通知、搜索对接与审计。
- **数据库**：PostgreSQL 14+（使用 `libpqxx` 直连；兼容 openGauss 协议）。
- **缓存/消息**：Redis（验证码、限流、会话黑名单、Pub/Sub、分布式锁）。
- **对象存储**：MinIO/S3（头像/附件/文档快照）。
- **全文检索（选做）**：Meilisearch 或 Elasticsearch。
- **部署**：本地开发环境；生产环境可选 Docker Compose；Nginx/Caddy 反向代理与 TLS；环境管理 `.env`。

逻辑分层：

- Web 前端（渲染与协作 UI）
- 协作层（CRDT + 房间）
- 业务 API 层（鉴权、权限、持久化、搜索、通知）
- 数据与基础设施层（PostgreSQL、Redis、对象存储、检索）

---

## 3. 数据库模型（PostgreSQL 方言，兼容 openGauss）

```sql
-- 用户与角色
CREATE TABLE "user" (
  id BIGSERIAL PRIMARY KEY,
  email VARCHAR(255) UNIQUE,
  phone VARCHAR(32) UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  role VARCHAR(32) NOT NULL DEFAULT 'viewer', -- admin/editor/viewer
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE user_profile (
  user_id BIGINT PRIMARY KEY REFERENCES "user"(id) ON DELETE CASCADE,
  nickname VARCHAR(64),
  avatar_url TEXT,
  bio TEXT
);

-- 文档与访问控制
CREATE TABLE document (
  id BIGSERIAL PRIMARY KEY,
  owner_id BIGINT NOT NULL REFERENCES "user"(id),
  title VARCHAR(255) NOT NULL,
  is_locked BOOLEAN NOT NULL DEFAULT FALSE,
  last_published_version_id BIGINT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE doc_acl (
  doc_id BIGINT NOT NULL REFERENCES document(id) ON DELETE CASCADE,
  user_id BIGINT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
  permission VARCHAR(16) NOT NULL, -- owner/editor/viewer
  PRIMARY KEY (doc_id, user_id)
);

-- 文档版本（快照元数据 + 存储位置）
CREATE TABLE document_version (
  id BIGSERIAL PRIMARY KEY,
  doc_id BIGINT NOT NULL REFERENCES document(id) ON DELETE CASCADE,
  snapshot_url TEXT NOT NULL,
  snapshot_sha256 CHAR(64) NOT NULL,
  size_bytes BIGINT NOT NULL,
  created_by BIGINT NOT NULL REFERENCES "user"(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 标签
CREATE TABLE tag (
  id BIGSERIAL PRIMARY KEY,
  name VARCHAR(64) UNIQUE NOT NULL
);

CREATE TABLE doc_tag (
  doc_id BIGINT NOT NULL REFERENCES document(id) ON DELETE CASCADE,
  tag_id BIGINT NOT NULL REFERENCES tag(id) ON DELETE CASCADE,
  PRIMARY KEY (doc_id, tag_id)
);

-- 评论
CREATE TABLE comment (
  id BIGSERIAL PRIMARY KEY,
  doc_id BIGINT NOT NULL REFERENCES document(id) ON DELETE CASCADE,
  author_id BIGINT NOT NULL REFERENCES "user"(id),
  anchor JSONB,
  content TEXT NOT NULL,
  parent_id BIGINT REFERENCES comment(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 任务
CREATE TABLE task (
  id BIGSERIAL PRIMARY KEY,
  doc_id BIGINT NOT NULL REFERENCES document(id) ON DELETE CASCADE,
  assignee_id BIGINT REFERENCES "user"(id),
  title VARCHAR(255) NOT NULL,
  status VARCHAR(32) NOT NULL DEFAULT 'todo', -- todo/doing/done
  due_at TIMESTAMPTZ,
  created_by BIGINT NOT NULL REFERENCES "user"(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 通知
CREATE TABLE notification (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
  type VARCHAR(64) NOT NULL,
  payload JSONB NOT NULL,
  is_read BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_document_owner_updated ON document(owner_id, updated_at DESC);
CREATE INDEX idx_doc_tag_tag ON doc_tag(tag_id);
CREATE INDEX idx_comment_doc_created ON comment(doc_id, created_at DESC);
CREATE INDEX idx_task_doc_status ON task(doc_id, status);
CREATE INDEX idx_notification_user_created ON notification(user_id, created_at DESC);
```

设计要点：文档正文不入行内字段，采用“快照对象存储（MinIO/S3）+ 元数据入库”的模式，便于大文档与版本化；全文检索由索引服务维护可检索文本。

---

## 4. API 设计（首版）

- 认证
  - POST `/api/auth/register`
  - POST `/api/auth/login` → `{ access_token, refresh_token }`
  - POST `/api/auth/refresh`
  - GET `/api/users/me`
  - PATCH `/api/users/me`
  - PUT `/api/users/me/avatar`

- 权限
  - GET `/api/roles`
  - GET `/api/docs/:id/acl`
  - PUT `/api/docs/:id/acl`

- 文档
  - POST `/api/docs`
  - GET `/api/docs/:id`
  - PATCH `/api/docs/:id`
  - DELETE `/api/docs/:id`
  - GET `/api/docs`（分页/筛选）
  - POST `/api/docs/:id/publish`
  - GET `/api/docs/:id/versions`
  - POST `/api/docs/:id/rollback/:versionId`

- 评论/任务/通知/搜索
  - 评论：GET/POST `/api/docs/:id/comments`，DELETE `/api/comments/:id`
  - 任务：GET/POST `/api/docs/:id/tasks`，PATCH `/api/tasks/:id`
  - 通知：GET `/api/notifications`，POST `/api/notifications/read`
  - 搜索：GET `/api/search?q=...&author=...&tag=...&from=...&to=...`

- 协作对接
  - POST `/api/collab/token`（加入房间令牌）
  - POST `/api/collab/snapshot/:docId`（协作服务快照回调）
  - GET `/api/collab/bootstrap/:docId`（最近快照地址）

请求/响应示例建议在后续“详细设计附录”中给出 JSON Schema。

---

## 5. 关键流程

1) 文档编辑与快照
   - 前端连接文档房间（Yjs）；定时或阈值触发快照；协作服务推送快照元数据到 C++ 后端。
   - 后端校验 ACL 与幂等 → 记录 `document_version` → 异步更新全文索引 → 通知协作者。

2) 协作加入鉴权
   - 客户端先从 C++ 后端申请一次性加入令牌（JWT）→ 携带加入房间；协作服务校验令牌与 ACL。

3) 版本发布/回滚
   - 发布：将某个版本设为 `last_published_version_id` 并刷新索引。
   - 回滚：把目标版本设为引导快照，触发发布流程。

伪代码（C++）：

```cpp
void handleCollabSnapshotWebhook(SnapshotMeta meta) {
  User caller = authenticate(meta.jwt);
  checkAcl(caller.id, meta.docId, Permission::Editor);
  if (isProcessed(meta.sha256)) return;
  auto size = headObject(meta.snapshotUrl).size;
  long versionId = saveDocumentVersion(meta.docId, meta.snapshotUrl, meta.sha256, size, caller.id);
  dispatchAsync([&]{ upsertSearchIndex(meta.docId, meta.snapshotUrl); });
  notifyCollaborators(meta.docId, "document.snapshot.saved", {versionId});
}
```

---

## 6. 非功能与安全

- 安全：JWT + 刷新、BCrypt 密码、上传大小/MIME 校验、速率限制、IP 黑白名单、审计日志。
- 性能：Redis 做热点/限流；快照异步处理；检索更新异步；必要时读写分离（选做）。
- 可观测：访问日志、关键操作审计；（选做）Prometheus + Grafana；集中日志（Loki/ELK）。

---

## 7. 部署与环境

- Docker Compose：openGauss、Redis、MinIO、Meilisearch、y-websocket、C++ 服务。
- 反向代理：Nginx/Caddy（TLS、静态资源、WebSocket 转发）。
- 配置：`.env` 管理凭据与连接串；生产与开发分环境。

### 7.1 开发环境要求

- 操作系统：Ubuntu 20.04/22.04（推荐）；WSL2 + Ubuntu 20.04
- 编译器：
  - GCC 11+ 或 Clang 15+
  - CMake 3.24+
- 运行时与工具：
  - Node.js 18+（协作服务与前端构建）
  - 包管理：PNPM 9+ 或 npm 9+
- 中间件版本：
  - PostgreSQL 14+（开发环境）；openGauss 兼容
  - Redis 7+
  - MinIO（S3 兼容，可选）
  - Meilisearch 1.7+（可选）

### 7.2 主要依赖（C++ 服务）

- Drogon 1.8+
- libpq / libpqxx（PostgreSQL）
- jwt-cpp（JWT）
- bcrypt（密码哈希）
- redis-plus-plus（Redis 客户端）
- cpr 或 Boost.Beast（HTTP 客户端）
- spdlog（日志）、nlohmann/json（JSON）

安装指引：

- Ubuntu 20.04/22.04：
  - `sudo apt update && sudo apt install -y build-essential cmake libpq-dev libpqxx-dev libssl-dev postgresql postgresql-contrib redis-server`
  - Drogon 通过 CMake FetchContent 自动下载编译
  - 其余库可通过 `apt` 或源码安装

### 7.3 协作服务与前端（可选，后续阶段）

- 协作：`y-websocket`（Node 18+），示例启动：
  - `node node_modules/y-websocket/bin/server.js --port 1234`
- 前端：React + Vite + TypeScript；安装启动：
  - `pnpm i`（或 `npm ci`）→ `pnpm dev`

### 7.4 本地开发启动（openGauss 为主）

- 使用 `./start-local.sh` 一键启动：PostgreSQL、Redis、C++ 服务（亦可切换 openGauss）
- 端口规划：
  - C++ API：8080
  - openGauss/PostgreSQL：5432
  - Redis：6379

### 7.5 .env 示例

```sql
# Database (openGauss / PostgreSQL)
DB_HOST=127.0.0.1
DB_PORT=5432
DB_NAME=collab
DB_USER=collab
DB_PASSWORD=collab_pass

# Redis
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_PASSWORD=

# JWT
JWT_SECRET=please_change_me
JWT_EXPIRES_IN=900
JWT_REFRESH_EXPIRES_IN=2592000

# Object Storage (MinIO) - 可选
S3_ENDPOINT=http://127.0.0.1:9000
S3_REGION=us-east-1
S3_ACCESS_KEY=minioadmin
S3_SECRET_KEY=minioadmin
S3_BUCKET=doc-snapshots

# Search - 可选
SEARCH_ENDPOINT=http://127.0.0.1:7700
SEARCH_API_KEY=

# Collaboration service
COLLAB_WS_URL=ws://127.0.0.1:1234
COLLAB_SNAPSHOT_WEBHOOK=http://127.0.0.1:8080/api/collab/snapshot

# Server
APP_PORT=8080
APP_ENV=development
```

说明：生产环境务必使用独立密钥与私有网络，敏感配置通过 Secret 管理。

---

## 8. 里程碑阶段与开发计划

-**已达成（当前）**
-C++ 服务可编译运行，数据库/依赖环境全部打通
-健康检查等基础 API 完成

-**1. 后端基础功能阶段**
-用户注册/登录/鉴权、JWT 流程
-文档 CRUD、权限 ACL
-单元测试、主线API测试

-**2. 实时协作与拓展**
-Yjs 对接，多人协作、光标管理
-评论、通知、任务API
-文档标签/搜索、自动保存

-**3. 版本/高级/运维阶段**
-历史版本、全文检索、PWA、监控、审计等

每阶段开发任务完成后同步更新接口文档，持续集成和自动化测试建议阶段推进。

---

## 9. 附录

- 术语：CRDT、Yjs、快照、ACL、RBAC。
- 待补：详细 API JSON Schema、错误码规范、配置样例。
