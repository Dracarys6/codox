# 总体设计文档

本文档描述多人在线协作编辑系统的整体架构设计，包括系统目标、技术架构、模块划分和开发路线图。

## 目录

1. [系统概述](#系统概述)
2. [技术架构](#技术架构)
3. [系统模块](#系统模块)
4. [数据模型概览](#数据模型概览)
5. [安全与合规](#安全与合规)
6. [性能与可用性](#性能与可用性)
7. [开发路线图](#开发路线图)

---

## 系统概述

### 目标与范围

**项目目标**：提供多人实时协作文档编辑、评论/任务、权限与版本管理，支持对象存储与全文检索。

**MVP 范围**：

- ✅ 账号与鉴权
- ✅ 文档 CRUD
- ✅ ACL（访问控制列表）
- ✅ 快照持久化与版本管理
- 📅 协作接入（Yjs + y-websocket）
- 📅 基础搜索
- 📅 通知系统

### 核心功能

- **用户管理**：注册/登录（邮箱/手机）、密码重置、个人资料、头像、联系信息
- **权限管理**：RBAC 角色（admin/editor/viewer）+ 文档级 ACL；操作审计
- **文档管理**：文档创建/编辑、模板、自动保存；标签/分类/搜索；版本历史、对比、回滚、锁定
- **实时协作**：多人同时编辑、实时光标/选区；评论/批注/回复/@及通知；任务分配与状态跟踪
- **通知与通讯**：站内实时通知（编辑、评论、任务）、历史与偏好

---

## 技术架构

### 整体架构

```架构
┌─────────────────────────────────────────────────────────────┐
│                       前端层                                  │
│  React + TypeScript + Tiptap (ProseMirror) + Yjs           │
└────────────────────┬────────────────────────────────────────┘
                     │ WebSocket
┌────────────────────▼────────────────────────────────────────┐
│                    协作层                                      │
│              y-websocket (Node.js)                           │
│          CRDT 合并、游标同步、会话管理                          │
└────────────────────┬────────────────────────────────────────┘
                     │ HTTP API
┌────────────────────▼────────────────────────────────────────┐
│                   业务后端层                                   │
│              C++ (Drogon Framework)                          │
│  鉴权、权限、文档元数据、版本、通知、搜索对接、审计               │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│                 数据与基础设施层                               │
│  PostgreSQL / openGauss │ Redis │ MinIO │ Meilisearch      │
└─────────────────────────────────────────────────────────────┘
```

### 技术选型

| 层级 | 技术 | 说明 |
|------|------|------|
| **前端** | React + TypeScript + Tiptap + Yjs | 富文本编辑器 + CRDT 协作 |
| **协作服务** | y-websocket (Node.js 18+) | 实时协作服务，CRDT 合并 |
| **业务后端** | C++ (Drogon 1.9.11+) | HTTP/WebSocket 框架 |
| **数据库** | PostgreSQL 14+ / openGauss | 兼容 openGauss 协议 |
| **缓存/消息** | Redis 7+ | 验证码、限流、会话、Pub/Sub |
| **对象存储** | MinIO / S3 | 头像/附件/文档快照 |
| **全文检索** | Meilisearch 1.7+ (可选) | 全文搜索 |

### 逻辑分层

- **Web 前端层**：渲染与协作 UI
- **协作层**：CRDT + 房间管理
- **业务 API 层**：鉴权、权限、持久化、搜索、通知
- **数据与基础设施层**：PostgreSQL、Redis、对象存储、检索

### 部署拓扑

**开发/演示环境**：

- 单机 WSL2 内：Docker Compose 启动 PostgreSQL、Redis、MinIO、Meilisearch、y-websocket、cpp-service
- Nginx/Caddy 反向代理前端与 API、WebSocket

**生产环境**：

- 容器化部署（Docker Compose）
- 反向代理配置 TLS
- 环境变量管理配置

---

## 系统模块

### 1. 用户与认证模块

- 用户注册、登录、Token 刷新
- 个人资料管理、头像上传
- 密码重置（计划中）

### 2. 权限模块

- 系统角色：Admin / Editor / Viewer
- 文档级 ACL：owner / editor / viewer
- 权限校验中间件

### 3. 文档模块

- 文档 CRUD 操作
- 标签管理
- 版本管理（快照元数据）
- 版本回滚
- 快照持久化

### 4. 协作对接模块

- 加入房间令牌生成
- 快照回调处理
- 引导快照获取
- 协作状态通知

### 5. 评论与任务模块

- 树形评论系统
- @ 提及功能
- 任务分配与状态跟踪
- 任务通知

### 6. 搜索模块

- Meilisearch 索引同步
- 全文搜索 API
- 搜索结果聚合

### 7. 通知模块

- 站内通知
- 未读计数
- 通知偏好设置
- Redis Pub/Sub 扇出（可选）

### 8. 审计与运维模块

- 关键操作审计日志
- 健康检查接口
- 日志管理
- 监控（可选）

---

## 数据模型概览

### 核心数据表

| 表名 | 说明 |
|------|------|
| `user` | 用户基本信息 |
| `user_profile` | 用户资料（昵称、头像、简介） |
| `document` | 文档元数据 |
| `doc_acl` | 文档访问控制列表 |
| `document_version` | 文档版本快照元数据 |
| `tag` | 标签 |
| `doc_tag` | 文档标签关联 |
| `comment` | 评论（树形结构） |
| `task` | 任务 |
| `notification` | 通知 |

### 设计要点

- **文档正文不入库**：采用"快照对象存储（MinIO/S3）+ 元数据入库"的模式
- **版本管理**：通过 `document_version` 表管理快照元数据
- **权限控制**：通过 `doc_acl` 表实现文档级权限控制
- **全文检索**：由索引服务维护可检索文本

详细的数据模型定义请参考《详细设计文档》。

---

## 安全与合规

### 认证安全

- **JWT 认证**：短期 access_token（15 分钟）+ 长期 refresh_token（30 天）
- **密码加密**：SHA-256 + 随机盐值（16 字节）
- **Token 刷新**：支持 refresh_token 刷新 access_token

### 授权安全

- **服务端强校验**：所有权限检查在服务端进行，避免前端绕过
- **ACL 验证**：文档操作前验证 ACL 权限
- **RBAC + ACL**：系统角色 + 文档级权限双重控制

### 数据安全

- **参数化查询**：防止 SQL 注入攻击
- **对象存储访问**：使用预签名/临时凭证
- **敏感配置**：环境变量或 Secret 管理

### 审计日志

- 登录操作记录
- 权限变更记录
- ACL 修改记录
- 版本发布/回滚记录

---

## 性能与可用性

### 性能优化

- **连接池**：数据库连接池管理（当前：5-10 个连接）
- **缓存策略**：Redis 缓存热点数据
- **异步处理**：快照处理、索引更新异步化
- **读写分离**：后续可选（主从复制）

### 可用性保障

- **容错机制**：协作服务异常时保留本地编辑（Yjs 离线），恢复后自动合并
- **幂等处理**：快照回调支持幂等操作
- **健康检查**：`/health` 接口监控服务状态
- **降级策略**：搜索服务不可用时降级到数据库查询

### 扩展性

- **水平扩展**：无状态服务，支持多实例部署
- **负载均衡**：Nginx/Caddy 反向代理
- **消息队列**：Redis Pub/Sub 支持异步通知

---

## 开发路线图

### ✅ 第一阶段（已完成）

- [x] 项目环境搭建
- [x] 数据库初始化
- [x] 用户认证系统（注册/登录/刷新）
- [x] 健康检查接口
- [x] JWT 令牌管理
- [x] 密码加密实现
- [x] 用户资料管理（GET/PATCH /api/users/me）

### ✅ 第二阶段（已完成）

- [x] 文档 CRUD 接口
  - [x] POST /api/docs（创建文档）
  - [x] GET /api/docs（列表查询）
  - [x] GET /api/docs/:id（获取文档）
  - [x] PATCH /api/docs/:id（更新文档）
  - [x] DELETE /api/docs/:id（删除文档）
- [x] 文档权限管理（ACL）
  - [x] GET /api/docs/:id/acl（获取 ACL）
  - [x] PUT /api/docs/:id/acl（设置 ACL）
- [x] 文档版本管理
  - [x] POST /api/docs/:id/publish（发布版本）
  - [x] GET /api/docs/:id/versions（版本列表）
  - [x] POST /api/docs/:id/rollback/:versionId（版本回滚）

### 📅 第三阶段（开发指南已完成）

- [ ] 实时协作接入
  - [ ] Yjs + WebSocket 集成
  - [ ] POST /api/collab/token（协作令牌）
  - [ ] POST /api/collab/snapshot/:docId（快照回调）
  - [ ] GET /api/collab/bootstrap/:docId（引导快照）
- [ ] 评论系统
  - [ ] GET/POST /api/docs/:id/comments
  - [ ] DELETE /api/comments/:id
- [ ] 任务管理
  - [ ] GET/POST /api/docs/:id/tasks
  - [ ] PATCH /api/tasks/:id
- [ ] 通知系统
  - [ ] GET /api/notifications
  - [ ] POST /api/notifications/read
- [ ] 全文搜索
  - [ ] GET /api/search
  - [ ] Meilisearch 索引同步

### 📅 第四阶段（未来规划）

- [ ] 文档导入导出（Word/PDF/Markdown）
- [ ] 文档模板系统
- [ ] 移动端支持（PWA）
- [ ] 监控与告警（Prometheus + Grafana）
- [ ] 集中日志（Loki/ELK）

---

## 参考文档

- [详细设计文档](./详细设计.md) - 详细的技术实现、API 设计、数据库模型
- [第一阶段开发指南](./第一阶段开发指南.md) - 第一阶段开发指南
- [第二阶段开发指南](./第二阶段开发指南.md) - 第二阶段开发指南
- [第三阶段开发指南](./第三阶段开发指南.md) - 第三阶段开发指南（实时协作、评论、任务与搜索）
