# 多人在线协作编辑系统 - 总体设计（WSL2 Ubuntu 20.04 + libpqxx）

## 1. 目标与范围

- 目标：提供多人实时协作文档编辑、评论/任务、权限与版本管理，支持对象存储与全文检索。
- 范围（MVP）：账号与鉴权、文档 CRUD、ACL、协作接入（Yjs+y-websocket）、快照持久化与版本、基础搜索、通知。

## 2. 系统架构

- 前端：React + TypeScript + Tiptap + Yjs；WebSocket 连接协作服务。
- 协作服务：y-websocket（Node 18+），负责 CRDT 合并与房间管理；通过回调向后端提交快照。
- 业务后端：C++（Drogon）
  - 鉴权与权限（jwt-cpp、RBAC + 文档 ACL）
  - 文档与版本、评论、任务、通知 API
  - 快照接收与对象存储对接、搜索索引更新
  - 数据访问：libpqxx 直连 openGauss
- 数据与中间件：openGauss、Redis、MinIO、Meilisearch。

## 3. 部署拓扑（开发/演示）

- 单机 WSL2 内：Docker Compose 启动 openGauss、Redis、MinIO、Meilisearch、y-websocket、cpp-service。
- Nginx/Caddy 反代前端与 API、WebSocket。

## 4. 模块划分

- 用户与认证模块：注册、登录、Token 刷新、个人资料、头像上传。
- 权限模块：系统角色（Admin/Editor/Viewer）、文档级 ACL（owner/editor/viewer）。
- 文档模块：文档 CRUD、标签、版本、回滚；快照元数据管理。
- 协作对接模块：加入令牌、引导快照、快照回调、通知。
- 评论与任务模块：树形评论、@ 提及、任务分配/状态。
- 搜索模块：Meilisearch 索引同步与查询聚合。
- 通知模块：站内通知、未读计数、偏好设置；后续可加入 Redis Pub/Sub 扇出。
- 审计与运维模块：关键操作审计、健康检查、日志与（可选）监控。

## 5. 数据模型（概要）

- user, user_profile, document, doc_acl, document_version, tag, doc_tag, comment, task, notification（详见《设计文档》数据库章节）。

## 6. 安全与合规

- 认证：JWT（短期）+ 刷新；密码使用 BCrypt。
- 授权：服务端强校验 ACL，避免前端绕过。
- 数据：对象存储访问使用预签名/临时凭证；敏感配置置于环境变量或 Secret。
- 审计：登录、权限变更、ACL 修改、版本发布/回滚均落库。

## 7. 性能与可用性

- 读写分离（后续可选）、缓存热点数据、异步索引、快照阈值触发、幂等处理。
- 容错：协作服务异常时保留本地编辑（Yjs 离线），恢复后自动合并。

## 8. 里程碑

- M1：认证与用户、文档 CRUD、ACL、健康检查
- M2：协作接入、快照持久化、版本列表
- M3：评论/任务/通知
- M4：搜索、版本回滚、审计与部署收尾
