# 项目启动指南

本文档说明如何启动多人在线协作文档系统的所有服务。

## 📋 服务清单

根据开发阶段，需要启动的服务如下：

### 基础服务（必需）

1. **PostgreSQL 数据库** - 数据存储
2. **C++ 后端服务** - API 服务（端口 8080）
3. **前端服务** - React 应用（端口 5173）

### 第三阶段服务（可选）

4. **协作服务** - y-websocket 服务（端口 1234）
5. **Meilisearch** - 全文搜索服务（端口 7700）
6. **MinIO** - 对象存储服务（端口 9000/9001）

---

## 🚀 启动步骤

### 方式一：手动启动（开发环境推荐）

#### 1. 启动 PostgreSQL 数据库

```bash
# 启动 PostgreSQL 服务
sudo service postgresql start

# 检查服务状态
sudo service postgresql status

# 如果需要创建数据库（首次运行）
sudo -u postgres psql << EOF
CREATE DATABASE collab;
CREATE USER collab WITH PASSWORD '20050430';
GRANT ALL PRIVILEGES ON DATABASE collab TO collab;
\q
EOF

# 执行数据库初始化脚本（首次运行）
PGPASSWORD=20050430 psql -h 127.0.0.1 -p 5432 -U collab -d collab -f cpp-service/sql/init.sql
```

#### 2. 启动 C++ 后端服务

```bash
cd cpp-service

# 编译（首次运行或代码修改后）
mkdir -p build && cd build
cmake ..
make -j$(nproc)

# 运行服务
./cpp-service

# 服务运行在 http://localhost:8080
```

**新开一个终端窗口继续以下步骤**

#### 3. 启动前端服务

```bash
cd frontend

# 安装依赖（首次运行）
npm install

# 启动开发服务器
npm run dev

# 服务运行在 http://localhost:5173
```

#### 4. 启动协作服务（第三阶段）

```bash
cd collab-service

# 安装依赖（首次运行）
npm install

# 启动服务
npm start
# 或
npx tsx server.ts

# 服务运行在 ws://localhost:1234
```

#### 5. 启动 Meilisearch（第三阶段，可选）

```bash
# 使用 Docker 启动
docker run -d \
  --name meilisearch \
  -p 7700:7700 \
  -v $(pwd)/meili_data:/meili_data \
  getmeili/meilisearch:latest \
  meilisearch --master-key="your_master_key_here"

# 或使用 docker-compose（见下方）
```

#### 6. 启动 MinIO（第三阶段，可选）

```bash
# 使用 Docker 启动
docker run -d \
  --name minio \
  -p 9000:9000 \
  -p 9001:9001 \
  -v $(pwd)/minio_data:/data \
  -e MINIO_ROOT_USER=minioadmin \
  -e MINIO_ROOT_PASSWORD=minioadmin \
  minio/minio:latest server /data --console-address ":9001"

# 访问 MinIO 控制台: http://localhost:9001
```

---

### 方式二：使用 Docker Compose（推荐用于完整环境）

创建 `docker-compose.yml`：

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:14
    container_name: multiuser-postgres
    environment:
      POSTGRES_DB: collab
      POSTGRES_USER: collab
      POSTGRES_PASSWORD: 20050430
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./cpp-service/sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U collab"]
      interval: 10s
      timeout: 5s
      retries: 5

  meilisearch:
    image: getmeili/meilisearch:latest
    container_name: multiuser-meilisearch
    ports:
      - "7700:7700"
    volumes:
      - meili_data:/meili_data
    environment:
      - MEILI_MASTER_KEY=your_master_key_here
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:7700/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio:latest
    container_name: multiuser-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

volumes:
  postgres_data:
  meili_data:
  minio_data:
```

启动所有服务：

```bash
# 启动基础服务（PostgreSQL, Meilisearch, MinIO）
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

**注意**：C++ 后端、前端和协作服务仍需要手动启动（见方式一）。

---

## 📝 启动检查清单

启动所有服务后，检查以下端点：

- ✅ **PostgreSQL**: `psql -h 127.0.0.1 -p 5432 -U collab -d collab -c "SELECT 1;"`
- ✅ **C++ 后端**: `curl http://localhost:8080/health`
- ✅ **前端**: 浏览器访问 `http://localhost:5173`
- ✅ **协作服务**: `curl http://localhost:1234` (应该返回 WebSocket 升级错误，这是正常的)
- ✅ **Meilisearch**: `curl http://localhost:7700/health`
- ✅ **MinIO**: 浏览器访问 `http://localhost:9001`

---

## 🔧 快速启动脚本

创建 `start-dev.sh`：

```bash
#!/bin/bash

# 启动 PostgreSQL
echo "启动 PostgreSQL..."
sudo service postgresql start

# 启动 Docker 服务（如果使用）
if [ -f "docker-compose.yml" ]; then
    echo "启动 Docker 服务..."
    docker-compose up -d
fi

# 启动 C++ 后端服务
echo "启动 C++ 后端服务..."
cd cpp-service/build
./cpp-service &
CPP_PID=$!
echo "C++ 后端服务 PID: $CPP_PID"

# 启动前端服务
echo "启动前端服务..."
cd ../../frontend
npm run dev &
FRONTEND_PID=$!
echo "前端服务 PID: $FRONTEND_PID"

# 启动协作服务（如果存在）
if [ -d "../collab-service" ]; then
    echo "启动协作服务..."
    cd ../collab-service
    npm start &
    COLLAB_PID=$!
    echo "协作服务 PID: $COLLAB_PID"
fi

echo ""
echo "所有服务已启动！"
echo "前端: http://localhost:5173"
echo "后端 API: http://localhost:8080"
echo "协作服务: ws://localhost:1234"
echo ""
echo "按 Ctrl+C 停止所有服务"

# 等待中断信号
trap "kill $CPP_PID $FRONTEND_PID $COLLAB_PID 2>/dev/null; exit" INT
wait
```

使用方式：

```bash
chmod +x start-dev.sh
./start-dev.sh
```

---

## 🛑 停止服务

### 手动停止

```bash
# 停止 C++ 后端（在运行终端按 Ctrl+C）

# 停止前端（在运行终端按 Ctrl+C）

# 停止协作服务（在运行终端按 Ctrl+C）

# 停止 PostgreSQL
sudo service postgresql stop

# 停止 Docker 服务
docker-compose down
```

### 使用脚本停止

```bash
# 停止所有 Node.js 进程
pkill -f "tsx server.ts"
pkill -f "vite"

# 停止 C++ 后端
pkill -f "cpp-service"

# 停止 Docker 服务
docker-compose down
```

---

## ⚠️ 常见问题

### 1. 端口被占用

```bash
# 检查端口占用
sudo lsof -i :8080  # C++ 后端
sudo lsof -i :5173  # 前端
sudo lsof -i :1234  # 协作服务
sudo lsof -i :5432  # PostgreSQL
sudo lsof -i :7700  # Meilisearch
sudo lsof -i :9000  # MinIO

# 杀死占用进程
sudo kill -9 <PID>
```

### 2. 数据库连接失败

- 检查 PostgreSQL 是否运行：`sudo service postgresql status`
- 检查 `cpp-service/config.json` 中的数据库配置
- 检查数据库用户权限

### 3. 前端无法连接后端

- 检查 `frontend/.env` 中的 `VITE_API_URL` 配置
- 检查 C++ 后端是否正常运行
- 检查浏览器控制台的错误信息

### 4. 协作服务连接失败

- 检查协作服务是否运行
- 检查 `frontend/.env` 中的 `VITE_WS_URL` 配置
- 检查 WebSocket 连接是否被防火墙阻止

---

## 📚 相关文档

- [第一阶段开发指南](./第一阶段开发指南.md)
- [第二阶段开发指南](./第二阶段开发指南.md)
- [第三阶段开发指南](./第三阶段开发指南.md)
- [详细设计文档](./详细设计.md)

---

**祝开发顺利！** 🚀

