# 总体设计文档

本文档描述多人在线协作编辑系统的整体架构设计，包括系统目标、技术架构、模块划分和开发路线图。

## 目录

1. [系统概述](#系统概述)
2. [技术架构](#技术架构)
3. [系统模块](#系统模块)
4. [数据模型概览](#数据模型概览)
5. [安全与合规](#安全与合规)
6. [性能与可用性](#性能与可用性)
7. [开发路线图](#开发路线图)

---

## 系统概述

### 目标与范围

**项目目标**：提供多人实时协作文档编辑、评论/任务、权限与版本管理，支持对象存储与全文检索。

**MVP 范围**：

- ✅ 账号与鉴权
- ✅ 文档 CRUD + ACL（访问控制列表）
- ✅ 快照持久化与版本管理（MinIO + `document_version` 元数据）
- ✅ 协作接入（Yjs + y-websocket，引导快照/快照回调闭环）
- ✅ 基础搜索（Meilisearch 集成）
- ✅ 通知系统 V1（列表、未读计数、已读同步）
- ✅ 实时通讯后台（聊天室、消息、WebSocket 网关）
- ✅ 文档导入导出（Word/PDF/Markdown，独立转换服务）
- 🔄 第四阶段增强：通知过滤/设置、版本时间线、用户管理与运营看板

### 核心功能

- **用户管理**：注册/登录、Token 刷新、个人资料、即将上线的管理员视角（列表、权限、行为数据）
- **权限管理**：RBAC 角色（admin/editor/viewer）+ 文档级 ACL；版本/ACL 变更审计
- **文档管理**：文档 CRUD、标签、快照/版本历史、MinIO 快照存储、导入导出（Word/PDF/Markdown）
- **实时协作与通讯**：Yjs + y-websocket，多人协作编辑、聊天室、光标同步、任务/评论联动
- **通知系统**：站内通知、未读计数、Webhook/WS 推送、即将上线的通知过滤与偏好设置

---

## 技术架构

### 整体架构

```架构
┌─────────────────────────────────────────────────────────────┐
│                       前端层                                  │
│  React + TypeScript + Tiptap (ProseMirror) + Yjs           │
└────────────────────┬────────────────────────────────────────┘
                     │ WebSocket
┌────────────────────▼────────────────────────────────────────┐
│                    协作层                                      │
│              y-websocket (Node.js)                           │
│          CRDT 合并、游标同步、会话管理                          │
└────────────────────┬────────────────────────────────────────┘
                     │ HTTP API
┌────────────────────▼────────────────────────────────────────┐
│                   业务后端层                                   │
│              C++ (Drogon Framework)                          │
│  鉴权、权限、文档元数据、版本、通知、搜索对接、审计               │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│                 数据与基础设施层                               │
│  PostgreSQL / openGauss │ Redis │ MinIO │ Meilisearch      │
│  doc-converter-service (Node.js) │
└─────────────────────────────────────────────────────────────┘
```

### 技术选型

| 层级 | 技术 | 说明 |
|------|------|------|
| **前端** | React + TypeScript + Tiptap + Yjs | 富文本编辑器 + CRDT 协作 |
| **协作服务** | y-websocket (Node.js 18+) | 实时协作服务，CRDT 合并 |
| **业务后端** | C++ (Drogon 1.9.11+) | HTTP/WebSocket 框架 |
| **数据库** | PostgreSQL 14+ / openGauss | 兼容 openGauss 协议 |
| **缓存/消息** | Redis 7+ | 验证码、限流、会话、Pub/Sub |
| **对象存储** | MinIO / S3 | 头像/附件/文档快照 |
| **全文检索** | Meilisearch 1.7+ (可选) | 全文搜索 |
| **文档转换** | doc-converter-service (Node.js) | Word/PDF/Markdown 格式转换 |

### 逻辑分层

- **Web 前端层**：渲染与协作 UI
- **协作层**：CRDT + 房间管理
- **业务 API 层**：鉴权、权限、持久化、搜索、通知
- **数据与基础设施层**：PostgreSQL、Redis、对象存储、检索

### 部署拓扑

**开发/演示环境**：

- 单机 WSL2 内：Docker Compose 启动 PostgreSQL、Redis、MinIO、Meilisearch、y-websocket、cpp-service
- Nginx/Caddy 反向代理前端与 API、WebSocket

**生产环境**：

- 容器化部署（Docker Compose）
- 反向代理配置 TLS
- 环境变量管理配置

---

## 系统模块

### 1. 用户与认证模块

- 用户注册、登录、Token 刷新
- 个人资料管理、头像上传
- 密码重置（计划中）

### 2. 权限模块

- 系统角色：Admin / Editor / Viewer
- 文档级 ACL：owner / editor / viewer
- 权限校验中间件

### 3. 文档与版本模块

- 文档 CRUD 操作、标签管理
- 快照持久化（MinIO）与 SHA256 校验
- 版本时间线：发布、回滚、将上线的差异对比与自动/手动版本策略
- 文档导入导出（Word / PDF / Markdown，规划中）

### 4. 协作对接模块

- 加入房间令牌生成
- 快照回调处理
- 引导快照获取
- 协作状态通知

### 5. 评论与任务模块

- 树形评论系统
- @ 提及功能
- 任务分配与状态跟踪
- 任务通知

### 6. 实时通讯模块

- 文档聊天室自动创建
- 聊天室/消息 CRUD、文件消息复用 MinIO
- WebSocket 广播、typing/read 事件
- 未读计数与消息回执

### 7. 通知模块

- 站内通知
- 未读计数
- 通知偏好设置（即将上线）
- WebSocket 推送（规划中）

### 8. 搜索模块

- Meilisearch 索引同步
- 全文搜索 API
- 搜索结果聚合

### 9. 审计与运维模块

- 关键操作审计日志
- 健康检查接口
- 日志管理、Prometheus / Grafana（规划中）
- 集中日志（Loki / ELK，规划中）

---

## 数据模型概览

### 核心数据表

| 表名 | 说明 |
|------|------|
| `user` | 用户基本信息 |
| `user_profile` | 用户资料（昵称、头像、简介） |
| `document` | 文档元数据 |
| `doc_acl` | 文档访问控制列表 |
| `document_version` | 文档版本快照元数据 |
| `tag` | 标签 |
| `doc_tag` | 文档标签关联 |
| `comment` | 评论（树形结构） |
| `task` | 任务 |
| `chat_room` / `chat_room_member` / `chat_message` / `chat_message_read` | 聊天室、成员、消息与未读记录 |
| `notification` | 通知 |
| `notification_setting` | 通知偏好设置（开启/关闭邮件、推送、站内） |
| `user_activity_daily`（规划） | 用户行为聚合数据（登录、活跃度，用于运营分析） |

### 设计要点

- **文档正文不入库**：采用"快照对象存储（MinIO/S3）+ 元数据入库"的模式
- **版本管理**：通过 `document_version` 表管理快照元数据
- **权限控制**：通过 `doc_acl` 表实现文档级权限控制
- **全文检索**：由索引服务维护可检索文本

详细的数据模型定义请参考《详细设计文档》。

---

## 安全与合规

### 认证安全

- **JWT 认证**：短期 access_token（15 分钟）+ 长期 refresh_token（30 天）
- **密码加密**：SHA-256 + 随机盐值（16 字节）
- **Token 刷新**：支持 refresh_token 刷新 access_token

### 授权安全

- **服务端强校验**：所有权限检查在服务端进行，避免前端绕过
- **ACL 验证**：文档操作前验证 ACL 权限
- **RBAC + ACL**：系统角色 + 文档级权限双重控制

### 数据安全

- **参数化查询**：防止 SQL 注入攻击
- **对象存储访问**：使用预签名/临时凭证
- **敏感配置**：环境变量或 Secret 管理

### 审计日志

- **登录操作记录**
- **权限变更记录**
- **ACL 修改记录**
- **版本发布/回滚记录**

---

## 性能与可用性

### 性能优化

- **连接池**：数据库连接池管理（当前：5-10 个连接）
- **缓存策略**：Redis 缓存热点数据
- **异步处理**：快照处理、索引更新异步化
- **读写分离**：后续可选（主从复制）

### 可用性保障

- **容错机制**：协作服务异常时保留本地编辑（Yjs 离线），恢复后自动合并
- **幂等处理**：快照回调支持幂等操作
- **健康检查**：`/health` 接口监控服务状态
- **降级策略**：搜索服务不可用时降级到数据库查询

### 扩展性

- **水平扩展**：无状态服务，支持多实例部署
- **负载均衡**：Nginx/Caddy 反向代理
- **消息队列**：Redis Pub/Sub 支持异步通知

---

## 开发路线图

### ✅ 第一阶段（已完成）

- [x] 项目环境搭建
- [x] 数据库初始化
- [x] 用户认证系统（注册/登录/刷新）
- [x] 健康检查接口
- [x] JWT 令牌管理
- [x] 密码加密实现
- [x] 用户资料管理（GET/PATCH /api/users/me）

### ✅ 第二阶段（已完成）

- [x] 文档 CRUD 接口
  - [x] POST /api/docs（创建文档）
  - [x] GET /api/docs（列表查询）
  - [x] GET /api/docs/:id（获取文档）
  - [x] PATCH /api/docs/:id（更新文档）
  - [x] DELETE /api/docs/:id（删除文档）
- [x] 文档权限管理（ACL）
  - [x] GET /api/docs/:id/acl（获取 ACL）
  - [x] PUT /api/docs/:id/acl（设置 ACL）
- [x] 文档版本管理
  - [x] POST /api/docs/:id/publish（发布版本）
  - [x] GET /api/docs/:id/versions（版本列表）
  - [x] POST /api/docs/:id/rollback/:versionId（版本回滚）

### ✅ 第三阶段（已完成）

- [x] 实时协作接入
  - [x] Yjs + WebSocket 集成
  - [x] POST /api/collab/token（协作令牌）
  - [x] POST /api/collab/snapshot/:docId（快照回调）
  - [x] GET /api/collab/bootstrap/:docId（引导快照）
- [x] 评论系统
  - [x] GET/POST /api/comments
  - [x] PUT /api/comments/:id
  - [x] DELETE /api/comments/:id
- [x] 任务管理
  - [x] GET/POST /api/tasks
  - [x] PUT /api/tasks/:id
  - [x] PATCH /api/tasks/:id/status
- [x] 通知系统
  - [x] GET /api/notifications
  - [x] POST /api/notifications/read
- [x] 全文搜索
  - [x] GET /api/search
  - [x] Meilisearch 索引同步
  - [x] 文档索引自动更新

### 📅 第四阶段（当前开发）

- [x] 文档权限管理强化（GET/PUT ACL、前端 `AclManager` 验收）
- [x] 实时通讯模块（ChatController、WebSocket、未读消息）
- [x] 通知系统筛选功能（类型、文档ID、日期范围、未读状态筛选）✅
- [x] 文档导入导出（Word / PDF / Markdown）✅
- [x] 文档状态管理（状态字段、自动更新、状态筛选）✅
- [x] 主页统计优化（协作文档、需要关注文档）✅
- [ ] 通知偏好设置和 WebSocket 实时推送
- [ ] 文档版本控制增强（自动/手动版本、diff、恢复体验）
- [ ] 用户管理与运营（用户列表、权限调整、行为分析、满意度调查）

---

## 参考文档

- [详细设计文档](./ARCH-02-详细设计.md) - 详细的技术实现、API 设计、数据库模型
- [需求文档](./REQ-01-需求文档.md) - 项目需求文档
- [API 设计文档](./API-01-API设计.md) - API 设计文档
- [第一阶段开发指南](./PHASE-01-用户认证开发指南.md) - 第一阶段开发指南（用户认证）
- [第二阶段开发指南](./PHASE-02-文档管理开发指南.md) - 第二阶段开发指南（文档管理、权限、版本）
- [第三阶段开发指南](./PHASE-03-协作功能开发指南.md) - 第三阶段开发指南（实时协作、评论、任务与搜索）✅
- [第四阶段开发指南](./PHASE-04-功能完善开发指南.md) - 第四阶段开发指南（实时通讯、通知增强、导入导出、版本与用户管理）
- [项目启动指南](./GUIDE-01-项目启动指南.md) - 项目启动和运行指南
