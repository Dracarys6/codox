# 第一阶段开发指南：用户认证与文档 CRUD

## 🎯 第一阶段目标

完成用户认证（注册/登录）和文档基础 CRUD（创建/读取/更新/删除）功能。

---

## 📋 开发步骤

### 步骤 1：初始化数据库（已完成 ✅）

已创建 `cpp-service/sql/init.sql`，执行：

```bash
psql -h 127.0.0.1 -p 5432 -U collab -d collab -f cpp-service/sql/init.sql
```

### 步骤 2：创建项目目录结构

```
cpp-service/src/
├── controllers/     # API 控制器
├── models/         # 数据模型（可选，直接 SQL 也可以）
├── utils/          # 工具类（JWT、密码哈希、数据库连接）
├── middleware/     # 中间件（JWT 认证过滤器）
└── services/       # 业务逻辑层（可选）
```

### 步骤 3：实现工具类（优先级：高）

#### 3.1 JWT 工具类 (`src/utils/JwtUtils.h` + `.cc`)

- 生成 access_token / refresh_token
- 验证 token 有效性
- 解析 token 获取用户信息
- 依赖：需要安装 `jwt-cpp` 库

#### 3.2 密码工具类 (`src/utils/PasswordUtils.h` + `.cc`)

- BCrypt 密码哈希
- 密码验证
- 依赖：需要安装 `libbcrypt` 或使用 OpenSSL 的加密函数

#### 3.3 数据库工具类 (`src/utils/DbUtils.h` + `.cc`)

- 数据库连接池封装（使用 Drogon 内置连接池）
- 执行 SQL 查询的便捷函数
- 事务管理

### 步骤 4：实现认证控制器 (`src/controllers/AuthController.h` + `.cc`)

#### 4.1 注册接口 `POST /api/auth/register`

- 请求体：`{ "email": "user@example.com", "password": "..." }`
- 验证邮箱格式、密码强度
- 哈希密码后存入数据库
- 返回：`{ "id": 123 }`

#### 4.2 登录接口 `POST /api/auth/login`

- 请求体：`{ "email": "...", "password": "..." }`
- 验证邮箱密码
- 生成并返回 JWT token
- 返回：`{ "access_token": "...", "refresh_token": "...", "user": {...} }`

#### 4.3 刷新 token `POST /api/auth/refresh`

- 请求体：`{ "refresh_token": "..." }`
- 验证 refresh_token
- 生成新的 access_token
- 返回：`{ "access_token": "..." }`

### 步骤 5：实现 JWT 认证中间件 (`src/middleware/JwtAuthFilter.h` + `.cc`)

- 从 HTTP Header `Authorization: Bearer <token>` 提取 token
- 验证 token 有效性
- 将用户信息注入到请求上下文（供后续控制器使用）
- 未认证请求返回 401

### 步骤 6：实现用户信息控制器 (`src/controllers/UserController.h` + `.cc`)

#### 6.1 获取当前用户 `GET /api/users/me`（需要认证）

- 从 JWT 中获取用户 ID
- 查询数据库返回用户信息
- 返回：`{ "id": 123, "email": "...", "role": "...", "profile": {...} }`

#### 6.2 更新用户信息 `PATCH /api/users/me`（需要认证）

- 请求体：`{ "nickname": "...", "bio": "..." }`
- 更新数据库
- 返回更新后的用户信息

### 步骤 7：实现文档 CRUD 控制器 (`src/controllers/DocumentController.h` + `.cc`)

#### 7.1 创建文档 `POST /api/docs`（需要认证）

- 请求体：`{ "title": "..." }`
- 创建文档记录，设置 owner_id 为当前用户
- 返回：`{ "id": 456, "title": "...", "owner_id": 123 }`

#### 7.2 获取文档 `GET /api/docs/:id`（需要权限检查）

- 验证用户是否有查看权限（owner/editor/viewer 或 ACL）
- 返回文档信息

#### 7.3 更新文档 `PATCH /api/docs/:id`（需要权限检查）

- 验证用户是否有编辑权限（owner/editor）
- 更新文档标题等信息
- 返回更新后的文档

#### 7.4 删除文档 `DELETE /api/docs/:id`（需要权限检查）

- 验证用户是否有删除权限（owner）
- 删除文档及相关 ACL、标签等
- 返回 204 No Content

#### 7.5 文档列表 `GET /api/docs`（需要认证）

- 支持分页：`?page=1&limit=20`
- 支持筛选：`?owner_id=123`、`?tag=work`
- 返回文档列表和总数

---

## 🛠️ 技术实现要点

### JWT 库安装（如果需要）

如果系统没有 `jwt-cpp`，可以通过 CMake FetchContent 或手动安装：

```cmake
# 在 CMakeLists.txt 中
include(FetchContent)
FetchContent_Declare(
    jwt-cpp
    GIT_REPOSITORY https://github.com/Thalhammer/jwt-cpp.git
    GIT_TAG master
)
FetchContent_MakeAvailable(jwt-cpp)
```

### 密码哈希（使用 OpenSSL）

如果不想安装 bcrypt，可以用 OpenSSL 的哈希函数：

```cpp
#include <openssl/sha.h>
// 或者使用 Drogon 内置的工具
```

### 数据库连接

Drogon 已提供数据库连接池，直接使用：

```cpp
#include <drogon/orm/DbClient.h>
auto db = drogon::app().getDbClient();
```

---

## 📝 开发顺序建议

1. ✅ **数据库初始化**（已完成）
2. 🔧 **工具类**（JWT、密码、数据库）
3. 🔐 **认证控制器**（注册/登录，先不做中间件，手动验证）
4. 👤 **用户信息控制器**（先不做中间件，手动验证 token）
5. 📄 **文档 CRUD**（先不做 ACL，只验证 owner）
6. 🛡️ **JWT 中间件**（统一认证逻辑）
7. 🔒 **ACL 权限检查**（完善文档权限）

---

## ✅ 测试建议

每个接口完成后，用 curl 或 Postman 测试：

```bash
# 注册
curl -X POST http://localhost:8080/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"test123"}'

# 登录
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"test123"}'

# 获取当前用户（需要 token）
curl -X GET http://localhost:8080/api/users/me \
  -H "Authorization: Bearer <your_token>"
```

---

## 🚀 开始开发

建议从 **工具类（JWT、密码）** 开始，然后是 **注册/登录接口**，逐步迭代！

每一步完成后，立即测试接口，确保功能正常再继续下一步。
